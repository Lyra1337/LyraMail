<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="css/jquery-ui-1.8.16.custom.css" />
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"
            integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
            integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
            crossorigin="anonymous"></script>
    <script type="text/javascript">
        var timestamp = 0;
        var mailCheckRunning = false;
        var mails = Array();

        $(function () {
            $.ajax({
                async: true,
                cache: false,
                url: "/api.json?action=getinitialdata",
                success: function (json) {

                },
                error: function (err) {
                    console.debug("startup-error: %o", err);
                }
            });

            checkMails();
        });

        function show_plain(counter) {
            var current = mails[counter].BodyParts;
            for (i = 0; i < current.length; i++) {
                if (current[i].ContentType.indexOf("plain") != -1) {
                    $('#mailpreview').text(current[i].BodyText);
                    return;
                }
            }

            $('#mailpreview').html('<div style="text-align: center; color: #FF3333; font-size: 18px;">plaintext unavailable</div>');
        }

        function show_html(counter) {
            var current = mails[counter].BodyParts;
            for (i = 0; i < current.length; i++) {
                if (current[i].ContentType.indexOf("html") != -1) {
                    $('#mailpreview').html(current[i].BodyText);
                    return;
                }
            }

            $('#mailpreview').html('<div style="text-align: center; color: #FF3333; font-size: 18px;">html unavailable</div>');
        }

        function checkMails() {
            if (mailCheckRunning) {
                return;
            }
            mailCheckRunning = true;

            var getString = "/api.json?action=getmails&timestamp=" + timestamp;
            $.ajax({
                dataType: "json",
                async: true,
                cache: false,
                url: getString,
                success: function (json) {
                    for (i = 0; i < json.length; i++) {
                        var current = json[i];

                        if (current.Time >= timestamp) {
                            timestamp = current.Time + 1;
                        }
                        $('#mails').append($('<tr/>').append($('<td/>').text(current.Sender))
                            .append($('<td/>').text(current.Recipient))
                            .append($('<td/>').text(current.Subject))
                            .append($('<td/>').text(current.Time))
                            .append($('<td/>').html("<a onclick=\"show_html(" + i + ");\" href=\"#show_html_" + i + "\">HTML</a>&#0160;&#0160;|&#0160;&#0160;<a onclick=\"show_plain(" + i + ");\" href=\"#show_plain_" + i + "\">Text</a>")));

                        mails.push(current);
                    }

                    mailCheckRunning = false;
                    checkMails();
                },
                error: function (err) {
                    console.debug("update-error: %o", err);
                    mailCheckRunning = false;
                    checkMails();
                }
            });
        }
    </script>
    <style type="text/css">
        body {
            font-family: Verdana, Arial, Helvetica, sans-serif;
            font-size: 8pt;
        }

        table.maillist thead {
            font-weight: bold;
            font-size: 10pt;
        }

        .contentstyle {
            width: 75%;
        }

        table.maillist {
            border-spacing: 0px;
            border-collapse: collapse;
            background-color: white;
            width: 100%;
        }

            table.maillist th {
                padding: 3px;
            }

            table.maillist thead {
                font-weight: bold;
                font-size: 10pt;
            }

            table.maillist tbody td {
                padding: 3px 20px;
            }

            table.maillist td {
                text-align: center;
                border-style: solid;
                border-width: 1px;
            }

        #mailpreview {
            margin: 10px 0px 0px 0px;
            border-width: 1px;
            padding: 3px 50px;
            border-style: solid;
        }
    </style>
    <title>Temp Mailer</title>
</head>
<body>
    <input id="mail" type="text" />
    <div class="contentstyle">
        <table id="mailtable" class="maillist">
            <thead>
                <tr>
                    <td>Sender</td>
                    <td>Empfänger</td>
                    <td>Betreff</td>
                    <td>Zeit</td>
                    <td>Anzeigen</td>
                </tr>
            </thead>
            <tbody id="mails"></tbody>
        </table>
        <div id="mailpreview"></div>
    </div>
</body>
</html>
